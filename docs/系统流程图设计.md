# TapLive MVP 系统流程图设计
## 核心业务流程与技术架构图

### 总体系统架构流程图

```mermaid
graph TD
    A[用户访问TapLive平台] --> B[语言选择 & 地理定位]
    B --> C[主页加载 - 网格背景动画]
    C --> D[实时订单数据获取]
    D --> E[地图集成 & 订单位置标记]
    
    E --> F{用户操作类型}
    F -->|创建订单| G[订单创建流程]
    F -->|浏览订单| H[订单筛选展示]
    F -->|接受订单| I[提供者匹配流程]
    F -->|观看直播| J[多屏网格流播放]
    
    G --> K[表单验证 & 地理安全检查]
    K --> L[订单存储 & 状态更新]
    L --> M[实时推送给附近提供者]
    
    H --> N[基于位置的智能排序]
    N --> O[分类筛选 & 搜索]
    O --> P[订单详情展示]
    
    I --> Q[调度算法计算最佳匹配]
    Q --> R[提供者评分排序]
    R --> S[订单分配 & 状态更新]
    
    J --> T[WebRTC连接建立]
    T --> U[多流并发管理]
    U --> V[自适应网格布局显示]
```

### 核心业务流程图

#### 1. 订单创建与匹配流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端React
    participant B as 后端Express
    participant D as 数据库
    participant W as WebSocket
    participant P as 提供者

    U->>F: 点击创建订单
    F->>F: 打开CreateOrderModal
    U->>F: 填写订单信息
    F->>F: Zod表单验证
    
    alt 验证通过
        F->>B: POST /api/orders
        B->>B: insertOrderSchema验证
        B->>B: 地理安全风险评估
        B->>D: 存储订单数据
        D-->>B: 返回订单ID
        B->>B: 调度算法计算匹配提供者
        B->>W: 广播新订单给附近提供者
        W->>P: 推送订单通知
        B-->>F: 返回成功响应
        F->>F: 关闭Modal & 刷新订单列表
        F->>U: 显示成功消息
    else 验证失败
        F->>U: 显示错误信息
    end
```

#### 2. 智能调度算法流程

```mermaid
flowchart TD
    A[新订单创建] --> B[获取订单地理位置]
    B --> C[查询附近可用提供者]
    C --> D[计算调度评分]
    
    D --> E[距离权重计算 - 20%]
    D --> F[信誉评分计算 - 40%]
    D --> G[设备性能评分 - 30%]
    D --> H[可用性奖励 - 10%]
    
    E --> I[综合评分排序]
    F --> I
    G --> I
    H --> I
    
    I --> J[生成提供者排名列表]
    J --> K[发送推送通知]
    K --> L{提供者响应}
    
    L -->|接受| M[更新订单状态为accepted]
    L -->|拒绝/超时| N[推送给下一个提供者]
    
    M --> O[开始直播准备]
    N --> P{是否还有候选者}
    P -->|是| K
    P -->|否| Q[订单标记为无人接单]
```

#### 3. 支付与佣金分配流程

```mermaid
graph TD
    A[用户选择支付订单] --> B{支付方式选择}
    
    B -->|Stripe卡支付| C[创建PaymentIntent]
    B -->|加密货币| D[生成钱包地址]
    
    C --> E[前端Stripe Elements]
    E --> F[用户输入支付信息]
    F --> G[Stripe处理支付]
    
    D --> H[用户转账到指定地址]
    H --> I[区块链交易验证]
    
    G --> J{支付结果}
    I --> J
    
    J -->|成功| K[更新订单支付状态]
    J -->|失败| L[显示支付失败信息]
    
    K --> M[通知提供者开始服务]
    M --> N[服务完成后提交审核]
    N --> O[客户确认服务质量]
    
    O --> P{客户审核结果}
    P -->|批准| Q[触发佣金分配]
    P -->|争议| R[启动争议处理流程]
    
    Q --> S[计算平台费用10%]
    S --> T[计算提供者收益90%]
    T --> U[实时佣金转账]
    U --> V[更新用户收益记录]
```

#### 4. 多屏直播网格管理流程

```mermaid
graph LR
    A[用户进入观看模式] --> B[检测当前活跃直播数]
    B --> C{直播流数量判断}
    
    C -->|1流| D[单屏全屏显示]
    C -->|2-4流| E[2x2网格]
    C -->|5-9流| F[3x3网格]
    C -->|10-16流| G[4x4网格]
    C -->|17+流| H[动态计算网格尺寸]
    
    D --> I[WebSocket连接管理]
    E --> I
    F --> I
    G --> I
    H --> I
    
    I --> J[建立WebRTC连接]
    J --> K[流状态监控]
    K --> L{连接状态检查}
    
    L -->|正常| M[继续播放]
    L -->|异常| N[自动重连机制]
    
    M --> O[带宽自适应调整]
    N --> P[故障转移处理]
    
    O --> Q[更新网格显示]
    P --> Q
    Q --> R[用户交互控制]
    R --> S[全屏/静音/关闭流]
```

### 数据库操作流程图

#### 1. 订单状态生命周期

```mermaid
stateDiagram-v2
    [*] --> pending: 创建订单
    
    pending --> open: 发布到市场
    pending --> cancelled: 创建者取消
    
    open --> accepted: 提供者接受
    open --> cancelled: 超时无人接单
    
    accepted --> live: 开始直播
    accepted --> cancelled: 提供者取消
    
    live --> awaiting_approval: 服务完成提交审核
    live --> cancelled: 服务中断
    
    awaiting_approval --> done: 客户批准
    awaiting_approval --> disputed: 客户提出争议
    
    disputed --> done: 争议解决-批准
    disputed --> cancelled: 争议解决-拒绝
    
    done --> [*]: 订单完成
    cancelled --> [*]: 订单取消
```

#### 2. 用户评分更新流程

```mermaid
flowchart TD
    A[订单完成] --> B[双方互相评价]
    B --> C[计算新评分]
    
    C --> D[获取用户历史评分]
    D --> E[加权平均算法]
    E --> F[更新rating字段]
    
    F --> G[增加totalRatings计数]
    G --> H[重新计算trustScore]
    H --> I[更新dispatchScore]
    
    I --> J[检查评分变化幅度]
    J --> K{是否触发等级调整}
    
    K -->|是| L[更新用户等级标识]
    K -->|否| M[保持当前等级]
    
    L --> N[发送等级变更通知]
    M --> O[流程结束]
    N --> O
```

### API调用时序图

#### 1. 获取订单列表API时序

```mermaid
sequenceDiagram
    participant C as 客户端
    participant R as React Query
    participant A as API层
    participant S as 存储层
    participant D as 数据库

    C->>R: 触发useQuery
    R->>A: GET /api/orders
    A->>S: storage.getAllOrders()
    S->>D: SELECT * FROM orders
    D-->>S: 返回订单数据
    S-->>A: 处理数据格式
    A-->>R: 返回JSON响应
    R->>R: 更新缓存
    R-->>C: 渲染订单列表
```

#### 2. 实时位置更新API时序

```mermaid
sequenceDiagram
    participant U as 用户设备
    participant F as 前端
    participant B as 后端
    participant D as 数据库
    participant A as 调度算法

    U->>F: GPS位置变化
    F->>F: 防抖处理(1秒)
    F->>B: POST /users/:id/location
    B->>D: UPDATE users SET lat, lng
    D-->>B: 更新确认
    B->>A: 重新计算dispatchScore
    A-->>B: 返回新的评分
    B-->>F: 返回成功响应
    F->>F: 更新本地状态
```

### WebSocket实时通信流程

```mermaid
graph TD
    A[客户端连接WebSocket] --> B[服务器验证连接]
    B --> C[维护连接映射表]
    
    C --> D[监听业务事件]
    D --> E{事件类型判断}
    
    E -->|新订单| F[按地理位置筛选目标用户]
    E -->|订单更新| G[通知相关用户]
    E -->|支付完成| H[通知提供者]
    E -->|直播开始| I[通知观看者]
    
    F --> J[发送订单推送消息]
    G --> J
    H --> J
    I --> J
    
    J --> K[客户端接收消息]
    K --> L[更新UI界面]
    
    L --> M{连接状态检查}
    M -->|正常| N[等待下次事件]
    M -->|断开| O[自动重连]
    O --> A
```

### 多语言国际化流程图

```mermaid
flowchart TD
    A[用户访问平台] --> B[检测浏览器语言偏好]
    B --> C{是否支持该语言}
    
    C -->|支持| D[设置为用户语言]
    C -->|不支持| E[默认使用英语]
    
    D --> F[加载对应语言包]
    E --> F
    
    F --> G[渲染界面文本]
    G --> H[用户手动切换语言]
    H --> I[保存到localStorage]
    I --> J[重新渲染界面]
    J --> K[更新所有TranslatedText组件]
```

### 系统监控与日志流程

```mermaid
graph TD
    A[系统运行时] --> B[性能指标收集]
    B --> C[错误日志记录]
    C --> D[用户行为追踪]
    
    D --> E{指标阈值检查}
    E -->|正常| F[继续监控]
    E -->|异常| G[触发告警]
    
    G --> H[发送邮件通知]
    H --> I[记录异常日志]
    I --> J[自动修复尝试]
    
    J --> K{修复结果}
    K -->|成功| L[记录修复日志]
    K -->|失败| M[升级告警级别]
    
    L --> F
    M --> N[人工介入处理]
```

### 部署与发布流程图

```mermaid
flowchart TD
    A[开发完成] --> B[本地测试]
    B --> C[代码提交Git]
    C --> D[触发CI/CD Pipeline]
    
    D --> E[自动化测试]
    E --> F{测试结果}
    
    F -->|通过| G[构建生产版本]
    F -->|失败| H[通知开发者]
    
    G --> I[部署到测试环境]
    I --> J[集成测试验证]
    J --> K{验证结果}
    
    K -->|通过| L[部署到生产环境]
    K -->|失败| M[回滚到上一版本]
    
    L --> N[健康检查]
    N --> O[监控系统启动]
    O --> P[发布完成]
    
    H --> Q[修复问题]
    M --> Q
    Q --> B
```

---

## 流程图说明

### 1. **总体系统架构流程图**
展示了用户从访问平台到各种操作的完整流程，包括订单创建、浏览、匹配和观看直播的主要路径。

### 2. **核心业务流程图**
详细描述了平台最重要的四个业务流程：订单创建与匹配、智能调度算法、支付与佣金分配、多屏直播网格管理。

### 3. **数据库操作流程图**
展示了订单状态的完整生命周期和用户评分更新的详细过程，确保数据一致性和业务逻辑正确性。

### 4. **API调用时序图**
描述了前后端交互的具体时序，包括数据获取和实时位置更新的完整流程。

### 5. **WebSocket实时通信流程**
展示了平台实时功能的核心实现，包括连接管理、事件分发和自动重连机制。

### 6. **系统监控与部署流程**
展示了平台的运维保障体系，包括监控告警和CI/CD自动化部署流程。

这些流程图为开发团队提供了清晰的系统架构指导，确保各个模块能够协调工作，实现平台的核心功能。